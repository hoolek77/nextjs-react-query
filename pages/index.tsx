import { dehydrate, QueryClient } from '@tanstack/react-query'
import { useEffect, useState } from 'react'

import Head from 'next/head'
import { useRouter } from 'next/router'

import fetchCharacters from '@/api/fetch-characters'
import CharactersList from '@/components/characters-list'
import Pagination from '@/components/pagination'
import useCharactersQuery from '@/hooks/use-characters-query'

import styled from 'styled-components'

const FIRST_PAGE = 1
const PAGE_SIZE = 20

export async function getStaticProps() {
  const queryClient = new QueryClient()

  await queryClient.prefetchQuery(['characters', FIRST_PAGE], () =>
    fetchCharacters(FIRST_PAGE)
  )

  return {
    props: {
      dehydratedState: dehydrate(queryClient),
    },
  }
}

export default function Home() {
  const [page, setPage] = useState(FIRST_PAGE)
  const { data, isLoading, isFetching, isError } = useCharactersQuery(page)
  const router = useRouter()

  useEffect(() => {
    router.replace(`/?page=${page}`, undefined, { shallow: true })
  }, [page])

  return (
    <>
      <Head>
        <title>Rick & Morty react-query</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main>
        <Heading>Rick & Morty Pagination</Heading>
        <Pagination
          count={data?.info.count as number}
          currentPage={page}
          onPageChange={(pageNumber) => setPage(pageNumber)}
          pageSize={PAGE_SIZE}
          disabled={isLoading || isFetching}
        />
        <CharactersList data={data} isLoading={isLoading} isError={isError} />
      </main>
    </>
  )
}

const Heading = styled.h1`
  font-weight: 500;
`
